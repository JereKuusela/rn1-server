<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="/lws-common.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery.min.js"></script>
<title>RN1 Webclient</title>
</head>

<body>
<article>


<table>
<tr>
<td style="width:1010px"><canvas id="map_canvas" width="1000" height="800" style="border:1px solid #000000;"></canvas></td>
<td style="width:200px">
	<input type=button id=charger value="Go to charger"><br>
	<input type=button id=estop value="STOP!!!"><br>
	<input type=button id=redraw value="Redraw"><br>
	<input type=button id=zoom_out value="Zoom out"><br>
	<input type=button id=zoom_in value="Zoom in"><br><br>
	<div id=bat_status>...</div><br>
	<div id=status>...</div><br>
</td>
</tr>
</table>

ws_url: <div id=ws_url>...</div><br>

<span id=wsdi_status>Websocket connection uninitialized</span>
<br>

<input type=button id=mode0 value="Mode0: user control, NO localization/mapping"> 
<br>
<input type=button id=mode1 value="Mode1: user control, with localization/mapping"> Normal operation mode. Stops autonomous operations.
<br>
<input type=button id=mode2 value="Mode2: autonomous mapping, skip compass">
<br>
<input type=button id=mode3 value="Mode3: autonomous mapping, start from compass"> Use this to localize the robot on the map. Let it run for a while, until localized.
<br>
<input type=button id=mode4 value="Mode4: DaijuMode">
<br>
<input type=button id=mode5 value="Mode5: Motors disabled, with localization/mapping"> Lets you move the robot freely
<br>
<input type=button id=mode6 value="Mode6: Motors disabled, NO localization/mapping"> Does not mess up the map if the robot is wrongly localized
<br>
<input type=button id=mode7 value="Program charger location"> Click this after you have put the robot IN the charger.
<br>

<input type=button id=restart value="Restart rn1host"> Restarts the robot raspi software<br>
<input type=button id=update value="Update rn1host from github"> Quits, does a git pull, compiles, and restarts the robot raspi software.<br>
<input type=button id=quit value="Quit rn1host"> Quits the robot raspi software. You need to manually restart it via ssh, or reboot the robot to get it run again.<br>
<input type=button id=reflash value="Update firmware(s)"> Place the firmware file(s) on the robot raspi filesystem, in /home/hrst/rn1-tools/main.bin or motcon.bin, then run this. Reflashes & restarts. Creates a log file at rn1-tools/program_log.txt<br>
<br>


<br>
<table border="1">
<tr><td><center><big><b>Manual control</b></big></center></td></tr>
<tr><td><center><small>For resolving problems, FWD/BACK 10 cm per click, LEFT/RIGHT 10 deg per click.</small></center></td></tr>
<tr><td><center>
<table border="0">
<tr><td></td><td><input type=button id=manu_fwd value="FWD"></td><td></td></tr>
<tr><td><input type=button id=manu_left value="LEFT"></td><td></td><td><input type=button id=manu_right value="RIGHT"></td></tr>
<tr><td></td><td><input type=button id=manu_back value="BACK"></td><td></td></tr>
</table></center>
</td></tr>
</table>

</article>

<script nonce="lwscaro">

document.getElementById('charger').onclick = charger;
document.getElementById('mode0').onclick = mode0;
document.getElementById('mode1').onclick = mode1;
document.getElementById('mode2').onclick = mode2;
document.getElementById('mode3').onclick = mode3;
document.getElementById('mode4').onclick = mode4;
document.getElementById('mode5').onclick = mode5;
document.getElementById('mode6').onclick = mode6;
document.getElementById('mode7').onclick = mode7;
document.getElementById('estop').onclick = mode5;

document.getElementById('manu_fwd').onclick = manu_fwd;
document.getElementById('manu_back').onclick = manu_back;
document.getElementById('manu_left').onclick = manu_left;
document.getElementById('manu_right').onclick = manu_right;


document.getElementById('redraw').onclick = redraw;
document.getElementById('zoom_out').onclick = do_zoom_out;
document.getElementById('zoom_in').onclick = do_zoom_in;

document.getElementById('restart').onclick = rn1host_restart;
document.getElementById('update').onclick = rn1host_update;
document.getElementById('quit').onclick = rn1host_quit;
document.getElementById('reflash').onclick = rn1host_reflash;

/*
 * We display untrusted stuff in html context... reject anything
 * that has HTML stuff in it
 */

function san(s)
{
	if (s.search("<") != -1)
		return "invalid string";
	
	return s;
}


function get_appropriate_ws_url()
{
	var pcol;
	var u = document.URL;

	if (u.substring(0, 5) == "https") {
		pcol = "wss://";
		u = u.substr(8);
	} else {
		pcol = "ws://";
		if (u.substring(0, 4) == "http")
			u = u.substr(7);
	}

	u = u.split('/');

	return pcol + u[0] + "/xxx";
}

/*
function get_appropriate_ws_url()
{
	return "wss://ojabotti.ha.fi:33333/xxx";
}
*/
document.getElementById("ws_url").textContent = get_appropriate_ws_url();
	

var canv = document.getElementById("map_canvas");
var ct = canv.getContext("2d");
var canv_w=canv.width;
var canv_h=canv.height;

var view_start_x = -3000;
var view_start_y = -3000;
var mm_per_pixel = 10.0;

var drag_start_x = 0.0;
var drag_start_y = 0.0;

var cur_angle = 0;
var cur_x = 0;
var cur_y = 0;

function update_view()
{
	var view_end_x = view_start_x + canv_w*mm_per_pixel;
	var view_end_y = view_start_y + canv_h*mm_per_pixel;

	var buffer = new ArrayBuffer(17);

	new DataView(buffer).setUint8(0, 1);
	new DataView(buffer).setInt32(1, view_start_x, false);
	new DataView(buffer).setInt32(5, view_start_y, false);
	new DataView(buffer).setInt32(9, view_end_x, false);
	new DataView(buffer).setInt32(13, view_end_y, false);

	var view_blob = new Blob([buffer], {type: "application/octet-stream"});
	socket_di.send(view_blob);
//	ct.clearRect(0, 0, canv_w, canv_h);
}

function scroll_view(x, y)
{
//	view_start_x -= x*mm_per_pixel;
//	view_start_y -= y*mm_per_pixel;

	update_view();
	draw_world();
}

var preview_last_x = 0;
var preview_last_y = 0;

function preview_scroll_view(x, y)
{
	var dx = x - preview_last_x;
	var dy = y - preview_last_y;
	preview_last_x = x;
	preview_last_y = y;
	if(dx != 0 && dy != 0)
	{
		ct.clearRect(0, 0, dx, canv_h);
		ct.clearRect(0, 0, canv_w, dy);
		var imageData = ct.getImageData(0, 0, canv_w-dx, canv_h-dy);
		ct.putImageData(imageData, dx, dy);
	}
}


function handle_click(xpix, ypix)
{
	ct.fillStyle = "red";
	ct.fillRect(xpix-5,ypix-5, 10, 10);

	var x_mm = xpix * mm_per_pixel + view_start_x;
	var y_mm = ypix * mm_per_pixel + view_start_y;

	var buffer = new ArrayBuffer(9);

	new DataView(buffer).setUint8(0, 2);
	new DataView(buffer).setInt32(1, x_mm, false);
	new DataView(buffer).setInt32(5, y_mm, false);

	var view_blob = new Blob([buffer], {type: "application/octet-stream"});
	socket_di.send(view_blob);
}

function charger()
{
	var buffer = new ArrayBuffer(1);
	new DataView(buffer).setUint8(0, 3);
	var view_blob = new Blob([buffer], {type: "application/octet-stream"});
	socket_di.send(view_blob);
}

function rn1host_restart() {restart_msg(1);}
function rn1host_quit()    {restart_msg(5);}
function rn1host_update()  {restart_msg(6);}
function rn1host_reflash() {restart_msg(10);}

function restart_msg(m)
{
	var buffer = new ArrayBuffer(2);
	new DataView(buffer).setUint8(0, 6);
	new DataView(buffer).setUint8(1, m);
	var view_blob = new Blob([buffer], {type: "application/octet-stream"});
	socket_di.send(view_blob);
}

function mode0() { mode(0); }
function mode1() { mode(1); }
function mode2() { mode(2); }
function mode3() { mode(3); }
function mode4() { mode(4); }
function mode5() { mode(5); }
function mode6() { mode(6); }
function mode7() { mode(7); }

function manu_fwd() { manu(10); }
function manu_back() { manu(11); }
function manu_left() { manu(12); }
function manu_right() { manu(13); }

function mode(m)
{
	var buffer = new ArrayBuffer(2);
	new DataView(buffer).setUint8(0, 4);
	new DataView(buffer).setUint8(1, m);
	var view_blob = new Blob([buffer], {type: "application/octet-stream"});
	socket_di.send(view_blob);
}

function manu(m)
{
	var buffer = new ArrayBuffer(2);
	new DataView(buffer).setUint8(0, 5);
	new DataView(buffer).setUint8(1, m);
	var view_blob = new Blob([buffer], {type: "application/octet-stream"});
	socket_di.send(view_blob);
}


var isDragging=false;

$(function()
{
	function handleMouseDown(e)
	{
		preview_last_x = 0;
		preview_last_y = 0;

		var rect = canv.getBoundingClientRect();
		drag_start_x=parseInt(e.clientX-rect.left);
		view_x_at_drag_start = view_start_x;
		view_y_at_drag_start = view_start_y;
		drag_start_y=parseInt(e.clientY-rect.top);
		isDragging=true;
	}

	function handleMouseUp(e)
	{
		if(isDragging)
		{
			var rect = canv.getBoundingClientRect();
			canMouseX=parseInt(e.clientX-rect.left);
			canMouseY=parseInt(e.clientY-rect.top);
			drag_x=canMouseX - drag_start_x;
			drag_y=canMouseY - drag_start_y;

			if(drag_x > -5 && drag_x < 5 && drag_y > -5 && drag_y < 5)
			{
				handle_click(canMouseX, canMouseY);
			}
			else
			{
				scroll_view(drag_x, drag_y);
			}
		}

		isDragging=false;
	}

	function handleMouseOut(e)
	{
		handleMouseUp(e);
	}

	function handleMouseMove(e)
	{
		var rect = canv.getBoundingClientRect();
		canMouseX=parseInt(e.clientX-rect.left);
		canMouseY=parseInt(e.clientY-rect.top);

		drag_x=canMouseX - drag_start_x;
		drag_y=canMouseY - drag_start_y;

		if(isDragging)
		{
//			preview_scroll_view(drag_x, drag_y);
			view_start_x = view_x_at_drag_start - drag_x*mm_per_pixel;
			view_start_y = view_y_at_drag_start - drag_y*mm_per_pixel;

			draw_world();

		}
	}

	$("#map_canvas").mousedown(function(e){handleMouseDown(e);});
	$("#map_canvas").mousemove(function(e){handleMouseMove(e);});
	$("#map_canvas").mouseup(function(e){handleMouseUp(e);});
	$("#map_canvas").mouseout(function(e){handleMouseOut(e);});
});


function do_zoom_out()
{
	mm_per_pixel *= 1.4;
	ct.clearRect(0, 0, canv_w, canv_h);
	draw_world();
	update_view();
}

function do_zoom_in()
{
	mm_per_pixel *= 0.7;
	ct.clearRect(0, 0, canv_w, canv_h);
	draw_world();
	update_view();
}

var socket_di;

if (typeof MozWebSocket != "undefined") {
	socket_di = new MozWebSocket(get_appropriate_ws_url(),
			   "rn1-protocol");
} else {
	socket_di = new WebSocket(get_appropriate_ws_url(),
			   "rn1-protocol");
}

var world = new Map();

function draw_robot(ang, x, y)
{

}

//
//    0             1
//                  
//                  2
//           M  O     3
//                  4
//               
//    6             5
//

var route_len = 0;
var route;

var robot_shape = [
	[-500,-200],
	[ 150,-200],
	[ 150,-100],
	[ 250,   0],
	[ 150, 100],
	[ 150, 200],
	[-500, 200]
];

function set_robot_size(xs, ys, origin_xoffs, origin_yoffs)
{
	// x coords
	robot_shape[0][0] = robot_shape[6][0] = -1*(xs/2+origin_xoffs);
	robot_shape[1][0] = robot_shape[2][0] = robot_shape[4][0] = robot_shape[5][0] = xs/2-origin_xoffs;
	robot_shape[3][0] = robot_shape[2][0] + 100;

	// y coords
	robot_shape[0][1] = robot_shape[1][1] = -1*(ys/2+origin_yoffs);
	robot_shape[5][1] = robot_shape[6][1] = ys/2-origin_yoffs;
	robot_shape[2][1] = -1*origin_yoffs - 50;
	robot_shape[3][1] = -1*origin_yoffs;
	robot_shape[4][1] = -1*origin_yoffs + 50;
}

function draw_world()
{
	ct.clearRect(0, 0, canv_w, canv_h);

	for(var [key,img] of world)
	{
		var img_x = (key[0] - view_start_x) / mm_per_pixel;
		var img_y = (key[1] - view_start_y) / mm_per_pixel;

		//console.log("x=" + key[0] + " y=" + key[1] + " --> " + img_x + "," + img_y + " is " + img);

		// let drawImage handle out-of-bounds coordinates, just try to draw everything
		ct.drawImage(img, img_x, img_y, (256*40)/mm_per_pixel, (256*40)/mm_per_pixel);
	}


	// Draw the robot

	var robot_x_pix = (cur_x - view_start_x) / mm_per_pixel;
	var robot_y_pix = (cur_y - view_start_y) / mm_per_pixel;


	ct.save();
	ct.translate(robot_x_pix, robot_y_pix);
	ct.rotate(cur_angle);
	ct.beginPath();
	ct.moveTo(robot_shape[0][0]/mm_per_pixel, robot_shape[0][1]/mm_per_pixel);
	for(var i=0; i<7; i++)
	{
		ct.lineTo(robot_shape[i][0]/mm_per_pixel, robot_shape[i][1]/mm_per_pixel);
	}
	ct.closePath();
	ct.fillStyle = "#C07040A0";
	ct.fill();
	ct.restore();

	if(route_len > 0)
	{
		ct.beginPath();
		ct.moveTo((route[0][0] - view_start_x) / mm_per_pixel, (route[0][1] - view_start_y) / mm_per_pixel);
		for(i = 0; i < route_len; i++)
		{
			ct.lineWidth = 3;
			if(route[i][2] > 0)
				ct.strokeStyle = "#C00000B0";
			else
				ct.strokeStyle = "#00C030B0";

			ct.lineTo((route[i][0] - view_start_x) / mm_per_pixel, (route[i][0] - view_start_x) / mm_per_pixel);
			ct.stroke();
			if(i < n_elems-1)
			{
				ct.beginPath();
				ct.moveTo((route[0][0] - view_start_x) / mm_per_pixel, (route[0][1] - view_start_y) / mm_per_pixel);
			}
		}
	}
}


try {
	socket_di.onopen = function() {
		document.getElementById("wsdi_status").innerHTML =
			" <b>websocket connection opened</b> " +
			san(socket_di.extensions);
	} 

	socket_di.onmessage =function got_packet(msg)
	{
		if(msg.data instanceof Blob)
		{
			var fileReader = new FileReader();
			fileReader.onload = function()
			{ 
				var arrayBuffer = this.result;
				var view = new Uint8Array(arrayBuffer.slice(0,3));

				var pay_size = view[1]*256+view[2];

				switch(view[0])
				{
					case 200:
					{
						var image = new Image();
						image.src = URL.createObjectURL(msg.data.slice(10, msg.data.size, "image/png"));
						var img_x_mm = (new DataView(arrayBuffer).getInt32(1, false));
						var img_y_mm = (new DataView(arrayBuffer).getInt32(5, false));
						var status = (new DataView(arrayBuffer).getUint8(9));
						image.width = 256;
						image.height = 256;
						world.set([img_x_mm, img_y_mm], image);
						break;

					}
					case 130:
					{
						cur_angle = (new DataView(arrayBuffer.slice(3,5)).getInt16(0, false)) / 65536 * 2 * Math.PI;
						cur_x = (new DataView(arrayBuffer.slice(5,9)).getInt32(0, false));
						cur_y = (new DataView(arrayBuffer.slice(9,13)).getInt32(0, false));
					}
					break;

					case 134:
					{
						var flags = (new DataView(arrayBuffer).getUint8(3));

						var str = "";
						if(flags & 1)
							str += " CHARGING ";
						if(flags & 2)
							str += " FULL ";

						var volts = (new DataView(arrayBuffer).getUint16(4, false));
						var percentage = (new DataView(arrayBuffer).getUint8(6));

						document.getElementById("bat_status").textContent = volts/1000 + "V  " + percentage + "%  " + str;
					}
					break;

					case 135:
					{
						route_len = pay_size/9;

						if(route_len == 0)
						{
							document.getElementById("status").textContent = "Sorry, no route found!";
							break;
						}
						document.getElementById("status").textContent = "Following route!";

						for(i = 0; i < route_len; i++)
						{
							route[i][2] = (new DataView(arrayBuffer).getUint8(i*9+3));
							route[i][0] = (new DataView(arrayBuffer).getInt32(i*9+4, false));
							route[i][1] = (new DataView(arrayBuffer).getInt32(i*9+8, false));
						}

					}
					break;

					case 131:
					{
						if(isDragging) break;

						var lidar_robot_angle = (new DataView(arrayBuffer.slice(3,5)).getInt16(0, false)) / 65536 * 360;
						var lidar_robot_x = (new DataView(arrayBuffer.slice(5,9)).getInt32(0, false));
						var lidar_robot_y = (new DataView(arrayBuffer.slice(9,13)).getInt32(0, false));

						for(i = 0; i < 180; i++)
						{
							var x = (new DataView(arrayBuffer.slice(13+2*i+0,13+2*i+1)).getInt8(0, false));
							var y = (new DataView(arrayBuffer.slice(13+2*i+1,13+2*i+2)).getInt8(0, false));
							if(x != 0 || y != 0)
							{
								x = x*40 + lidar_robot_x;
								y = y*40 + lidar_robot_y;

								var dot_x = (x - view_start_x) / mm_per_pixel;
								var dot_y = (y - view_start_y) / mm_per_pixel;

								var c = document.getElementById("map_canvas");
								var ctx = c.getContext("2d");
								ctx.fillStyle = "red";
								ctx.fillRect(dot_x-1,dot_y-1, 2, 2);
							}
						}


					}
					break;

					default:
					{
					}

				}

			};
			fileReader.readAsArrayBuffer(msg.data);

//				var reader = new FileReader();
//				reader.addEventListener("loadend", function() {});
//				reader.readAsArrayBuffer(msg.data);
			
		}
	} 

	socket_di.onclose = function(){
		document.getElementById("wsdi_status").textContent = " websocket connection CLOSED ";
	}
} catch(exception) {
	alert('<p>Error' + exception);  
}

var socket_status, jso, s;

if (typeof MozWebSocket != "undefined") {
	socket_status = new MozWebSocket(get_appropriate_ws_url(),
			   "lws-status");
} else {
	socket_status = new WebSocket(get_appropriate_ws_url(),
			   "lws-status");
}


try {
	socket_status.onopen = function() {
		document.getElementById("s_status").innerHTML =
			" <b>websocket connection opened</b><br>" +
			san(socket_status.extensions);
	} 

	socket_status.onmessage =function got_packet(msg) {
		var s;
		
		jso = JSON.parse(msg.data);
		
		document.getElementById("servinfo").innerHTML = 
			"<table><tr><td class=l>Build info</td><td>"+
				san(jso.version) + "</td></tr>" +
				"<tr><td class=l>Server info</td><td>" +
				san(jso.hostname) + "</td></tr>" +
				"</table>";
		s="<table>";
		var n;
		for (n = 0; n < jso.conns.length; n++) {
			var d = new Date(parseInt(jso.conns[n].time) * 1000);
			
			s = s + "<tr><td class=l>client " + (n + 1) +
			"</td><td><b>" + san(jso.conns[n].peer) +
			"</b><br>" + san(d.toString()) +
			"<br>" + san(jso.conns[n].ua) +
			"</td></tr>";
		}
		s = s + "</table>";
		
		document.getElementById("conninfo").innerHTML = s;
	} 

	socket_status.onclose = function(){
		document.getElementById("s_status").textContent = " websocket connection CLOSED ";
	}
} catch(exception) {
	alert('<p>Error' + exception);  
}

//function reset() {
//	socket_di.send("reset\n");
//}

function redraw()
{
	update_view();
	draw_world();
}

var socket_ot;

function ot_open() {
	if (typeof MozWebSocket != "undefined") {
		socket_ot = new MozWebSocket(get_appropriate_ws_url(),
				   "rn1-protocol");
	} else {
		socket_ot = new WebSocket(get_appropriate_ws_url(),
				   "rn1-protocol");
	}
	try {
		socket_ot.onopen = function() {
			document.getElementById("ot_statustd").style.backgroundColor = "#40ff40";
			document.getElementById("ot_status").innerHTML = " <b>websocket connection opened</b><br>" + san(socket_di.extensions);
			document.getElementById("ot_open_btn").disabled = true;
			document.getElementById("ot_close_btn").disabled = false;
			document.getElementById("ot_req_close_btn").disabled = false;
		} 

		socket_ot.onclose = function(e){
			document.getElementById("ot_statustd").style.backgroundColor = "#ff4040";
			document.getElementById("ot_status").textContent = " websocket connection CLOSED, code: " + e.code +
			", reason: " + e.reason;
			document.getElementById("ot_open_btn").disabled = false;
			document.getElementById("ot_close_btn").disabled = true;
			document.getElementById("ot_req_close_btn").disabled = true;
		}
	} catch(exception) {
		alert('<p>Error' + exception);  
	}
}

/* browser will close the ws in a controlled way */
function ot_close() {
	socket_ot.close(3000, "Bye!");
}

/* we ask the server to close the ws in a controlled way */
function ot_req_close() {
	socket_ot.send("closeme\n");
}

</script>

</body>
</html>
